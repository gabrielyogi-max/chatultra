<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS INTELLIGENCE // DASHBOARD</title>
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Fonts: Inter for UI, JetBrains Mono for Code -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE: VARIABLES & RESET --- */
        :root {
            /* Palette - Palantir/Professional Dark */
            --bg-app: #090a0c;
            --bg-panel: #111316;
            --bg-element: #1a1d21;
            --bg-hover: #22252a;
            
            --border-subtle: #242830;
            --border-focus: #3b82f6;
            
            --accent-primary: #3b82f6; /* Professional Blue */
            --accent-glow: rgba(59, 130, 246, 0.15);
            
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --text-dim: #64748b;

            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;

            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            
            --shadow-panel: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; }

        body { 
            background-color: var(--bg-app); 
            color: var(--text-main); 
            font-family: var(--font-ui); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- ICONS (SVG) --- */
        .icon {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .icon-sm { width: 14px; height: 14px; }
        .icon-lg { width: 20px; height: 20px; }

        /* --- LAYOUT --- */
        .main-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--bg-app);
        }

        @media (min-width: 768px) {
            .main-wrapper {
                padding: 20px;
                max-width: 1600px;
            }
            .interface-container {
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-panel);
            }
        }

        .interface-container { 
            flex: 1;
            background: var(--bg-panel); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: relative;
        }
        
        /* --- HEADER --- */
        .header {
            height: 60px;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-panel);
        }

        .brand {
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.5px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .brand-indicator {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .status-bar {
            display: flex;
            gap: 24px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
            transition: background-color 0.3s;
        }
        .status-dot.online { background: var(--success); box-shadow: 0 0 6px rgba(16, 185, 129, 0.4); }
        .status-dot.loading { background: var(--warning); animation: pulse 1.5s infinite; }
        .status-dot.offline { background: var(--danger); }

        /* --- TOOLBAR --- */
        .toolbar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-element);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .model-select-wrapper {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
        }

        select {
            width: 100%;
            background: var(--bg-panel);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 0.85rem;
            cursor: pointer;
            appearance: none;
            transition: border-color 0.2s;
        }

        select:hover { border-color: var(--text-muted); }
        select:focus { outline: none; border-color: var(--accent-primary); }

        .btn-tool {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn-tool:hover {
            background: var(--bg-hover);
            color: var(--text-main);
            border-color: var(--text-muted);
        }
        .btn-tool.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* --- CHAT AREA --- */
        #chat-history { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 24px; 
            scroll-behavior: smooth; 
            background: var(--bg-panel);
        }

        .message { 
            max-width: 90%; 
            line-height: 1.6; 
            position: relative; 
            font-size: 0.95rem; 
            animation: fadeIn 0.3s ease;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* User Message */
        .message.user { 
            align-self: flex-end; 
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.15);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            color: #e2e8f0;
        }
        .message.user .message-header { color: var(--accent-primary); justify-content: flex-end; }

        /* Bot Message */
        .message.bot { 
            align-self: flex-start; 
            width: 100%;
            max-width: 100%;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        .message.bot:last-child { border-bottom: none; }
        .message.bot .message-header { color: var(--text-dim); }

        /* Markdown Styles */
        .bot p { margin: 0 0 16px 0; }
        .bot p:last-child { margin: 0; }
        
        /* Inline Code */
        .bot code { 
            background: rgba(255,255,255,0.08); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: var(--font-code); 
            font-size: 0.85em; 
            color: #fbbf24; /* Amber for inline code visibility */
        }

        /* Code Blocks - The "Editor" Look */
        .code-block-wrapper {
            margin: 16px 0;
            background: #0d0e11; /* Darker than panel */
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #16181d;
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-family: var(--font-ui);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .code-lang {
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .copy-btn:hover { color: var(--text-main); }

        .bot pre {
            margin: 0;
            padding: 16px;
            overflow-x: auto;
            font-family: var(--font-code);
            font-size: 0.9rem;
            line-height: 1.5;
            color: #d1d5db;
        }

        .bot pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            color: inherit;
            white-space: pre; /* Essential for indentation */
            display: block;
        }

        /* --- INPUT AREA --- */
        .input-area {
            padding: 20px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border-subtle);
        }

        .attachment-preview {
            display: none; 
            background: var(--bg-element);
            padding: 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-subtle);
            width: fit-content;
        }

        .attachment-preview img {
            height: 48px;
            border-radius: var(--radius-sm);
            margin-right: 12px;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-element);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 10px;
            transition: border-color 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        textarea {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 8px;
            font-family: var(--font-ui);
            font-size: 0.95rem;
            resize: none;
            min-height: 24px;
            max-height: 200px;
        }
        textarea:focus { outline: none; }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover { background: var(--bg-hover); color: var(--text-main); }
        .btn-icon.active { color: var(--danger); animation: pulse 2s infinite; }

        .btn-send {
            height: 36px;
            padding: 0 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-send:hover { background: #2563eb; }
        .btn-send:disabled { background: var(--bg-hover); color: var(--text-dim); cursor: not-allowed; }

        /* --- UTILS --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    </style>
</head>
<body>

<!-- SVG SYMBOLS (ICONS) -->
<svg style="display: none;">
    <!-- Speaker -->
    <symbol id="icon-sound" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93L15.54 8.46a5 5 0 0 1 0 7.07l3.53 3.53"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></symbol>
    <!-- Mute -->
    <symbol id="icon-mute" viewBox="0 0 24 24"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></symbol>
    <!-- Download/Save -->
    <symbol id="icon-save" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
    <!-- Trash -->
    <symbol id="icon-trash" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
    <!-- Paperclip/Attach -->
    <symbol id="icon-attach" viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></symbol>
    <!-- Mic -->
    <symbol id="icon-mic" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></symbol>
    <!-- Copy -->
    <symbol id="icon-copy" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
</svg>

<div class="main-wrapper">
    <div class="interface-container">
        
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <div class="brand-indicator"></div>
                NEXUS INTELLIGENCE
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <div id="c1-dot" class="status-dot"></div>
                    <span id="c1-text">VISUAL: INIT</span>
                </div>
                <div class="status-item">
                    <div id="c2-dot" class="status-dot"></div>
                    <span id="c2-text">LOGIC: INIT</span>
                </div>
            </div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="model-select-wrapper">
                <select id="modelSelector">
                    <optgroup label="[ VISUAL CORE // GOOGLE GEMINI ]">
                        <option value="Cluster1|âœ¨ Google: Gemini 2.5 Flash Lite âš¡">Gemini 2.5 Flash Lite (Fast)</option>
                        <option value="Cluster1|âœ¨ Google: Gemini 3.0 Pro (Experimental)">Gemini 3.0 Pro (Preview)</option>
                        <option value="Cluster1|âœ¨ Google: Gemini 2.5 Pro">Gemini 2.5 Pro</option>
                    </optgroup>
                    
                    <optgroup label="[ VISUAL CORE // MISTRAL AI ]">
                        <option value="Cluster1|ðŸ‡«ðŸ‡· Mistral: Magistral Medium 2509">Mistral Medium v2509</option>
                        <option value="Cluster1|ðŸ‡«ðŸ‡· Mistral: Pixtral Large (Vision) ðŸ–¼ï¸">Pixtral Large (Vision)</option>
                        <option value="Cluster1|ðŸ‡«ðŸ‡· Mistral: Codestral 2508">Mistral Codestral</option>
                    </optgroup>
        
                    <optgroup label="[ VISUAL CORE // GROQ ]">
                        <option value="Cluster1|â˜ï¸ Groq: Llama 3.3 70B">Llama 3.3 70B</option>
                    </optgroup>
                    
                    <optgroup label="[ LOGIC CORE // REASONING ]">
                         <option value="Cluster2|ðŸš€ DeepSeek R1 Distill Qwen 7B (O Mais Inteligente - Novo!)">DeepSeek R1 (Reasoning)</option>
                         <option value="Cluster2|ðŸ³ DeepSeek Math 7B (Especialista Antigo)">DeepSeek Math</option>
                    </optgroup>
                </select>
            </div>
            
            <button class="btn-tool" onclick="toggleSound()" id="soundBtn">
                <svg class="icon-sm"><use href="#icon-sound" id="sndIconUse"/></svg>
                <span id="sndText">Sound On</span>
            </button>
            <button class="btn-tool" onclick="exportChat()">
                <svg class="icon-sm"><use href="#icon-save"/></svg>
                <span>Export</span>
            </button>
            <button class="btn-tool" onclick="clearChat()">
                <svg class="icon-sm"><use href="#icon-trash"/></svg>
                <span>Clear</span>
            </button>
        </div>

        <!-- Chat Output -->
        <div id="chat-history">
            <!-- Messages injected here -->
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div id="imagePreviewContainer" class="attachment-preview">
                <div style="display:flex; align-items:center;">
                    <img id="imagePreview" alt="Preview">
                    <div>
                        <div style="font-weight:600; font-size:0.85rem;">Image Attached</div>
                        <div style="font-size:0.75rem; color:var(--text-dim);" id="imageName">filename.jpg</div>
                    </div>
                </div>
                <button onclick="clearImage()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem;">&times;</button>
            </div>

            <div class="input-container">
                <!-- Hidden File Input -->
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                
                <button class="btn-icon" onclick="document.getElementById('fileInput').click()" title="Attach Image">
                    <svg class="icon"><use href="#icon-attach"/></svg>
                </button>
                
                <textarea id="userInput" placeholder="Type your message..." onkeypress="handleEnter(event)" rows="1"></textarea>
                
                <button class="btn-icon" id="micBtn" onclick="toggleVoice()" title="Voice Input">
                    <svg class="icon"><use href="#icon-mic"/></svg>
                </button>

                <button id="sendBtn" class="btn-send" onclick="sendMessage()">SEND</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

    const HF_TOKEN = ""; 
    const CLUSTERS = {
        "Cluster1": "Madras1/APIDOST", 
        "Cluster2": "Madras1/APISMALL" 
    };

    let clients = {};
    let selectedFile = null; 
    let soundEnabled = true;

    // --- AUDIO SYSTEM (Procedural) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        if (!soundEnabled) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        // More subtle, professional sounds
        if (type === 'type') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, now);
            gain.gain.setValueAtTime(0.01, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
            osc.start(now);
            osc.stop(now + 0.05);
        } else if (type === 'message') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(880, now + 0.15);
            gain.gain.setValueAtTime(0.02, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'error') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(150, now);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now);
            osc.stop(now + 0.2);
        }
    }

    // --- DOM Elements ---
    const c1Dot = document.getElementById('c1-dot');
    const c1Text = document.getElementById('c1-text');
    const c2Dot = document.getElementById('c2-dot');
    const c2Text = document.getElementById('c2-text');

    const sendBtn = document.getElementById('sendBtn');
    const historyDiv = document.getElementById('chat-history');
    const imagePreview = document.getElementById('imagePreview');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const userInput = document.getElementById('userInput');

    function updateStatus(cluster, status) {
        const dot = cluster === "Cluster1" ? c1Dot : c2Dot;
        const textSpan = cluster === "Cluster1" ? c1Text : c2Text;
        
        dot.className = "status-dot " + status;
        textSpan.innerText = cluster === "Cluster1" 
            ? (status === "online" ? "VISUAL: READY" : "VISUAL: OFF")
            : (status === "online" ? "LOGIC: READY" : "LOGIC: OFF");
    }

    async function connectToCluster(name, id) {
        updateStatus(name, "loading");
        try {
            const options = HF_TOKEN ? { hf_token: HF_TOKEN } : {};
            clients[name] = await Client.connect(id, options);
            updateStatus(name, "online");
        } catch (e) {
            console.error(`Error connecting ${name}:`, e);
            updateStatus(name, "offline");
        }
    }

    async function initSystem() {
        appendMessage("bot", "Initializing Nexus Intelligence Interface...");

        await Promise.all([
            connectToCluster("Cluster1", CLUSTERS["Cluster1"]),
            connectToCluster("Cluster2", CLUSTERS["Cluster2"])
        ]);
        
        // Remove init message or update it
        const lastMsg = historyDiv.lastElementChild;
        if(lastMsg) lastMsg.remove();
        
        appendMessage("bot", "System Online. All clusters operational.");
        playSound('message');
    }
    
    initSystem();

    // --- FEATURES ---

    // Toggle Sound
    window.toggleSound = function() {
        soundEnabled = !soundEnabled;
        const iconUse = document.getElementById('sndIconUse');
        const text = document.getElementById('sndText');
        
        if (soundEnabled) {
            iconUse.setAttribute('href', '#icon-sound');
            text.innerText = "Sound On";
        } else {
            iconUse.setAttribute('href', '#icon-mute');
            text.innerText = "Muted";
        }
    }

    // Export Chat
    window.exportChat = function() {
        let text = "";
        document.querySelectorAll('.message').forEach(msg => {
            const isUser = msg.classList.contains('user');
            const author = isUser ? "USER" : "NEXUS";
            const content = isUser ? msg.innerText.replace("USER", "").trim() : msg.querySelector('.bot-content') ? msg.querySelector('.bot-content').innerText : msg.innerText;
            text += `[${author}]: ${content}\n\n`;
        });
        
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `nexus_chat_${Date.now()}.txt`;
        a.click();
    }

    // Copy Code
    window.copyCode = function(btn) {
        const codeBlock = btn.closest('.code-block-wrapper').querySelector('code');
        const code = codeBlock.innerText;
        navigator.clipboard.writeText(code).then(() => {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span>Copied!</span>`;
            setTimeout(() => btn.innerHTML = originalHTML, 2000);
        });
    }

    // Voice Input
    window.toggleVoice = function() {
        const btn = document.getElementById('micBtn');
        if (!('webkitSpeechRecognition' in window)) {
            alert("Voice recognition not supported in this browser.");
            return;
        }

        if (window.recognition && window.recognition_active) {
            window.recognition.stop();
            return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = function() {
            window.recognition_active = true;
            btn.classList.add('active');
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            userInput.value += (userInput.value ? " " : "") + transcript;
            adjustTextareaHeight();
        };

        recognition.onend = function() {
            window.recognition_active = false;
            btn.classList.remove('active');
        };

        recognition.start();
        window.recognition = recognition;
    }

    // Auto-expand Textarea
    function adjustTextareaHeight() {
        userInput.style.height = 'auto';
        userInput.style.height = userInput.scrollHeight + 'px';
    }
    userInput.addEventListener('input', adjustTextareaHeight);

    // Image Handling
    window.handleFileSelect = function(event) {
        const file = event.target.files[0];
        if (file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                document.getElementById('imageName').innerText = file.name;
                previewContainer.style.display = 'flex';
                userInput.focus();
            }
            reader.readAsDataURL(file);
        }
    }

    window.clearImage = function() {
        selectedFile = null;
        document.getElementById('fileInput').value = "";
        previewContainer.style.display = 'none';
    }

    // --- MESSAGING LOGIC ---
    window.sendMessage = async function() {
        const modelSelect = document.getElementById('modelSelector');
        const userText = userInput.value;
        
        if (!userText.trim() && !selectedFile) return;

        const [targetCluster, modelName] = modelSelect.value.split('|');
        const activeClient = clients[targetCluster];

        if (!activeClient) { 
            appendMessage("bot", `**ERROR:** ${targetCluster} not initialized.`); 
            playSound('error');
            return; 
        }

        if (targetCluster === "Cluster2" && selectedFile) {
            appendMessage("bot", `**Notice:** Logic Core does not support visual input.`);
            clearImage();
        }

        userInput.value = "";
        userInput.style.height = 'auto';
        
        let userDisplay = userText.replace(/\n/g, "<br>");

        if (selectedFile && targetCluster === "Cluster1") {
            userDisplay += `<br><img src="${imagePreview.src}" style="max-height: 120px; border-radius: 6px; border: 1px solid #333; margin-top:10px;">`;
        }
        
        // Append User Message
        appendMessage("user", userDisplay, true);
        playSound('message');
        setLoading(true);

        try {
            let messageObj;
            if (selectedFile && targetCluster === "Cluster1") {
                messageObj = { text: userText, files: [selectedFile] };
            } else {
                messageObj = { text: userText, files: [] };
            }

            const result = await activeClient.predict("/chat", [ 
                messageObj, 
                [], 
                modelName 
            ]);
            
            let responseText = "";
            if (result && result.data && result.data[0] != null) {
                responseText = String(result.data[0]);
            } else {
                responseText = "No response received.";
            }

            appendMessage("bot", responseText);
            playSound('message');

        } catch (error) {
            console.error(error);
            let msg = error.message || String(error);
            if (msg.includes("GPU quota")) msg = "GPU usage limit reached. Please wait.";
            appendMessage("bot", `**SYSTEM ERROR:** ${msg}`);
            playSound('error');
        } finally {
            setLoading(false);
            if (targetCluster === "Cluster1") clearImage(); 
        }
    }

    // Configure Marked
    marked.setOptions({
        highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-' // match highlight.js expectations
    });

    // Custom Renderer for "Palantir" Code Blocks
    const renderer = new marked.Renderer();
    renderer.code = function(code, infostring, escaped) {
        const lang = (infostring || 'plaintext').match(/\S*/)[0];
        const validLang = hljs.getLanguage(lang) ? lang : 'plaintext';
        const highlighted = hljs.highlight(code, { language: validLang }).value;

        return `
            <div class="code-block-wrapper">
                <div class="code-header">
                    <span class="code-lang">${validLang}</span>
                    <button class="copy-btn" onclick="copyCode(this)">
                        <svg class="icon-sm"><use href="#icon-copy"/></svg> COPY
                    </button>
                </div>
                <pre><code class="hljs language-${validLang}">${highlighted}</code></pre>
            </div>
        `;
    };
    marked.use({ renderer });

    function appendMessage(role, text, isUserHtml = false) {
        const div = document.createElement('div'); 
        div.className = "message " + role; 
        
        let headerHtml = role === "user" 
            ? `<div class="message-header">YOU</div>` 
            : `<div class="message-header">NEXUS AI</div>`;

        let content = "";
        
        if (role === "user") {
            content = isUserHtml ? text : text.replace(/</g, "&lt;");
        } else {
            // Check for empty code blocks or formatting issues
            try {
                content = marked.parse(String(text || ""));
            } catch (e) {
                console.error("Markdown Error:", e);
                content = text;
            }
        }

        div.innerHTML = headerHtml + `<div class="${role === 'bot' ? 'bot-content' : ''}">${content}</div>`;
        historyDiv.appendChild(div);
        
        // Scroll to bottom
        historyDiv.scrollTop = historyDiv.scrollHeight;
    }
    
    function setLoading(isLoading) {
        sendBtn.disabled = isLoading; 
        sendBtn.innerText = isLoading ? "PROCESSING..." : "SEND";
        if (isLoading) {
            document.body.style.cursor = "wait";
        } else {
            document.body.style.cursor = "default";
            userInput.focus();
        }
    }
    
    window.clearChat = function() { 
        historyDiv.innerHTML = '<div class="message bot"><div class="message-header">SYSTEM</div><div>Context cleared.</div></div>'; 
    }
    
    window.handleEnter = function(e) { 
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault();
            window.sendMessage(); 
        }
    }
</script>
</body>
</html>
